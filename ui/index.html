<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      script-src  'self' 'unsafe-inline';
      style-src   'self' 'unsafe-inline';
      img-src     'self' data:;
      connect-src 'self' https://*;
    "
  />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NCIC MDT - Police Terminal</title>
<link rel="stylesheet" href="styles.css">
<style>
/* Minimal styles to support collapsible record details */
.record { border-radius:8px; padding:8px; margin:8px 0; background: #0b1012; border:1px solid rgba(255,255,255,0.03); display:block; }
.record .record-summary { display:flex; gap:12px; align-items:center; justify-content:space-between; cursor:pointer; }
.record .record-left { display:flex; gap:12px; align-items:center; }
.record .record-label { font-size:11px; color:var(--muted); }
.record .record-value { font-weight:600; font-size:13px; color:var(--text); }
.record .record-details { display:none; margin-top:10px; padding-top:8px; border-top:1px dashed rgba(255,255,255,0.03); color:var(--muted); }
.record.open .record-details { display:block; }
.record .toggle-icon { width:26px; height:26px; display:inline-flex; align-items:center; justify-content:center; border-radius:6px; background:rgba(255,255,255,0.02); color:var(--muted); font-size:12px; }
.results-title.small { font-size:12px; margin-bottom:6px; }
.tiny-meta { font-size:12px; color:var(--muted); }
</style>
</head>
<body>
  <div id="app" role="application" aria-label="NCIC MDT">
    <header id="app-header" data-tooltip="Drag to move — double click to center">
      <div class="brand" style="min-width:220px">
        <div class="badge-icon">LSPD</div>
        <div>
          <h1>NCIC — Mobile Data Terminal</h1>
          <div class="sub">In-car terminal · Tactical access</div>
        </div>
      </div>

      <div class="header-status" aria-hidden="false">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="dot" title="Connection"></div>
          <div class="small muted">ONLINE</div>

        </div>

        <div class="field">
          <div class="label">Unit</div>
          <div class="value">1-L-12</div>
        </div>

        <div class="field">
          <div class="label">Officer</div>
          <div class="value">#3467</div>
        </div>

        <button class="close-btn" id="btn-close" aria-label="Close MDT" data-tooltip="Close MDT (Esc)">✖</button>
      </div>
    </header>

    <div class="content">
      <!-- NAV -->
      <nav aria-label="MDT navigation">
        <button data-tab="plate" class="active" data-tooltip="Search vehicle plates (F1)">Plate Search <span class="kbd">F1</span></button>
        <button data-tab="id" data-tooltip="Search identities (F2)">ID Search <span class="kbd">F2</span></button>
        <button data-tab="reports" data-tooltip="Reports & incident logging (F3)">Reports <span class="kbd">F3</span></button>
        <button data-tab="warrants" data-tooltip="Manage warrants (F4)">Warrants <span class="kbd">F4</span></button>
        <button data-tab="dispatch" data-tooltip="Dispatch and active calls (F5)">Dispatch <span class="kbd">F5</span></button>
      </nav>

      <!-- MAIN PANE -->
      <div class="pane">
        <!-- controls -->
        <div class="controls" aria-hidden="false">
          <div class="form-group">
            <label for="plate-history">Search History</label>
            <select id="plate-history" aria-label="Plate search history" data-tooltip="Recent plate searches">
              <option value="">-- Select previous search --</option>
            </select>
          </div>

          <div class="form-group">
            <label for="id-history">ID History</label>
            <select id="id-history" aria-label="ID search history" data-tooltip="Recent ID lookups">
              <option value="">-- Select previous search --</option>
            </select>
          </div>

          <div class="form-group wide">
            <label for="plate-input">License Plate #</label>
            <input id="plate-input" type="text" placeholder="Enter plate number or scan vehicle" autocomplete="off" data-tooltip="Enter license plate, then Run Plate Search" />
          </div>

          <div class="form-group wide">
            <label for="id-input">First / LastName</label>
            <input id="id-input" type="text" placeholder="Enter partial or full name here" autocomplete="off" data-tooltip="NetID or 'First Last' names accepted" />
          </div>

          <div style="grid-column:1/3;display:flex;gap:10px">
            <button id="btn-plate" class="btn" data-tooltip="Lookup plate">Run Plate Search</button>
            <button id="btn-id" class="btn" data-tooltip="Lookup ID">Run ID Search</button>
          </div>
        </div>

        <!-- results -->
        <div class="results" role="region" aria-label="Results">
          <!-- Plate panel -->
          <section id="panel-plate" class="panel active" style="display:flex;flex-direction:column;height:100%">
            <div class="results-header">
              <div class="results-title">VEHICLE REGISTRATION RECORD</div>
              <button class="btn-compose tiny-btn" data-tooltip="Compose record (C)">Compose</button>
              <div id="id-status-indicator" class="status small">--</div>
            </div>

            <div id="plate-status" class="scroll">
              <div class="no-results">No search performed.</div>
            </div>
          </section>

          <!-- ID panel -->
          <section id="panel-id" class="panel" style="display:none;flex-direction:column;height:100%">
            <div class="results-header">
              <div class="results-title">IDENTITY RECORD</div>
              <!-- Compose button (use class btn-compose) -->
              <button class="btn-compose tiny-btn" data-tooltip="Compose record (C)">Compose</button>
              <div id="id-status-indicator" class="status small">--</div>
            </div>

            <div id="id-results" class="scroll">
              <div class="no-results">No search performed.</div>
            </div>
          </section>

          <!-- Reports panel -->
          <section id="panel-reports" class="panel" style="display:none;flex-direction:column;height:100%">
            <div class="results-header">
              <div class="results-title">REPORTS</div>
              <div class="status small">Records</div>
            </div>

            <div class="panel-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="report-title">Report Title</label>
                  <input id="report-title" type="text" placeholder="Title" data-tooltip="Short title for the report" />
                </div>
                <div class="form-group">
                  <label for="report-type">Report Type</label>
                  <select id="report-type" data-tooltip="Report type">
                    <option>General</option>
                    <option>Traffic</option>
                    <option>Use of Force</option>
                    <option>Suspicious</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="report-desc">Description</label>
                <textarea id="report-desc" placeholder="Description..." data-tooltip="Describe the incident"></textarea>
              </div>

              <div style="display:flex;gap:10px;margin-top:10px">
                <button id="btn-create-report" class="btn" style="flex:1" data-tooltip="Create a new report">Create Report</button>
                <button id="btn-list-reports" class="btn" style="flex:1" data-tooltip="Refresh report list">List Reports</button>
              </div>
            </div>

            <div id="reports-list" class="scroll">
              <div class="no-results">No reports.</div>
            </div>
          </section>

          <!-- Warrants -->
          <section id="panel-warrants" class="panel" style="display:none;flex-direction:column;height:100%">
            <div class="results-header">
              <div class="results-title">WARRANTS</div>
              <div class="status small">Active / Inactive</div>
            </div>

            <div class="panel-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="warrant-subject">Subject Name</label>
                  <input id="warrant-subject" type="text" placeholder="Subject Name" data-tooltip="Name to place on warrant" />
                </div>
                <div class="form-group">
                  <label for="warrant-netid">NetID (optional)</label>
                  <input id="warrant-netid" type="text" placeholder="NetID" data-tooltip="Optional NetID" />
                </div>
              </div>

              <div class="form-group">
                <label for="warrant-charges">Charges / Details</label>
                <textarea id="warrant-charges" placeholder="Charges / details..." data-tooltip="Charges or details for the warrant"></textarea>
              </div>

              <div style="display:flex;gap:10px;margin-top:10px">
                <button id="btn-create-warrant" class="btn" style="flex:1" data-tooltip="Create a warrant">Create Warrant</button>
                <button id="btn-list-warrants" class="btn" style="flex:1" data-tooltip="List Warrants">List Warrants</button>
              </div>
            </div>

            <div id="warrants-list" class="scroll">
              <div class="no-results">No warrants.</div>
            </div>
          </section>

          <!-- Dispatch -->
          <section id="panel-dispatch" class="panel" style="display:none;flex-direction:column;height:100%">
            <div class="results-header">
              <div class="results-title">DISPATCH / CALLS</div>
              <div class="status small">Live calls</div>
            </div>

            <div class="panel-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="dispatch-caller">Caller Name</label>
                  <input id="dispatch-caller" type="text" placeholder="Caller Name" data-tooltip="Name of caller" />
                </div>
                <div class="form-group">
                  <label for="dispatch-location">Location</label>
                  <input id="dispatch-location" type="text" placeholder="Location" data-tooltip="Location of the call" />
                </div>
              </div>

              <div class="form-group">
                <label for="dispatch-message">Message</label>
                <textarea id="dispatch-message" placeholder="Message..." data-tooltip="Call details"></textarea>
              </div>

              <div style="display:flex;gap:10px;margin-top:10px">
                <button id="btn-create-dispatch" class="btn" style="flex:1" data-tooltip="Create dispatch call">Create Dispatch</button>
                <button id="btn-list-dispatch" class="btn" style="flex:1" data-tooltip="List active calls">List Dispatch</button>
              </div>
            </div>

            <div id="dispatch-list" class="scroll">
              <div class="no-results">No active calls.</div>
            </div>
          </section>
        </div>
      </div>
    </div>
<!-- Compose Modal container (hidden by default) -->
<div id="compose-modal-backdrop" style="display:none;position:fixed;inset:0;z-index:100000;background:rgba(2,8,10,0.75);align-items:center;justify-content:center;">
  <div id="compose-modal" style="width:640px;max-width:95%;border-radius:8px;background:var(--panel);box-shadow:0 10px 40px rgba(0,0,0,0.6);padding:18px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div style="display:flex;flex-direction:column">
        <div style="color:var(--accent);font-weight:700">Compose Record</div>
        <div style="color:var(--muted);font-size:12px">Create Arrest / Ticket / Note linked to a plate or ID</div>
      </div>
      <div>
        <button id="compose-close" class="tiny-btn">Close</button>
      </div>
    </div>

    <div class="panel-form" style="padding:12px;background:transparent;border:none">
      <div style="display:flex;gap:10px;margin-bottom:8px">
        <div style="flex:1">
          <label style="font-size:12px;color:var(--muted);text-transform:uppercase">Record Type</label>
          <select id="compose-type" style="width:100%;padding:10px;border-radius:4px">
            <option value="arrest">Arrest</option>
            <option value="ticket">Ticket</option>
            <option value="note">Note</option>
          </select>
        </div>

        <div style="width:180px">
          <label style="font-size:12px;color:var(--muted);text-transform:uppercase">Target</label>
          <select id="compose-target-type" style="width:100%;padding:10px;border-radius:4px">
            <option value="plate">Plate</option>
            <option value="netid">NetID</option>
            <option value="name">Name</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom:8px">
        <label style="font-size:12px;color:var(--muted);text-transform:uppercase">Target Value (plate / netId / name)</label>
        <input id="compose-target-value" type="text" style="width:100%;padding:10px;border-radius:4px" placeholder="e.g. ABC123 / 23 / John Doe" />
      </div>

      <div style="margin-bottom:8px">
        <label style="font-size:12px;color:var(--muted);text-transform:uppercase">Title</label>
        <input id="compose-title" type="text" style="width:100%;padding:10px;border-radius:4px" placeholder="Short title (e.g. 'Misdemeanor arrest')" />
      </div>

      <div style="margin-bottom:12px">
        <label style="font-size:12px;color:var(--muted);text-transform:uppercase">Description</label>
        <textarea id="compose-desc" style="width:100%;padding:10px;border-radius:4px" placeholder="Full description..."></textarea>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="compose-submit" class="btn">Save Record</button>
        <button id="compose-cancel" class="tiny-btn">Cancel</button>
      </div>

      <div id="compose-meta" style="margin-top:10px;color:var(--muted);font-size:12px"></div>
    </div>
  </div>
</div>

    <!-- bottom-right resize grip -->
    <div class="resize-grip" id="resizeGrip" title="Drag to resize" data-tooltip="Drag to resize window" tabindex="0">
      <div class="bars"><div></div></div>
    </div>
  </div>

<script>
  // NCIC MDT - behaviour preserved (keeps same IDs / message handling)
  (function () {
    'use strict';

    // -----------------------
    // layout persistence keys
    // -----------------------
    const LAYOUT_KEY = 'ncic_mdt_layout_v2';
    function setCookie(name, value, days=365){ try { const d=new Date(); d.setTime(d.getTime() + (days*24*60*60*1000)); document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + d.toUTCString() + ";path=/"; } catch(e){} }
    function getCookie(name){ try { const m = document.cookie.match('(^|;)\s*' + name + '\s*=\s*([^;]+)'); return m ? decodeURIComponent(m.pop()) : null; } catch(e){return null} }
    function saveLayoutState(state){ try{ localStorage.setItem(LAYOUT_KEY, JSON.stringify(state)); }catch(e){} try{ setCookie(LAYOUT_KEY, JSON.stringify(state), 365);}catch(e){} }
    function loadLayoutState(){ try{ const s = localStorage.getItem(LAYOUT_KEY); if(s) return JSON.parse(s); const c = getCookie(LAYOUT_KEY); if(c) return JSON.parse(c); }catch(e){} return null; }

    // -----------------------
    // keep original sendUI + DOM ids
    // -----------------------
    function sendUI(event, data) {
      try {
        fetch(`https://${GetParentResourceName()}/${event}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json; charset=UTF-8' },
          body: JSON.stringify(data || {})
        }).catch(e => {
          console.warn('sendUI fetch error', e);
        });
      } catch (err) {
        console.warn('sendUI error', err);
      }
    }

    // DOM refs (IDs preserved so NUI messages still work)
    const app = document.getElementById('app');
    const btnClose = document.getElementById('btn-close');
    const header = document.getElementById('app-header');
    const grip = document.getElementById('resizeGrip');

    const plateInput = document.getElementById('plate-input');
    const plateHistorySel = document.getElementById('plate-history');
    const btnPlate = document.getElementById('btn-plate');
    const plateStatus = document.getElementById('plate-status');
    const plateIndicator = document.getElementById('plate-status-indicator');

    const idInput = document.getElementById('id-input');
    const idHistorySel = document.getElementById('id-history');
    const btnId = document.getElementById('btn-id');
    const idResults = document.getElementById('id-results');
    const idIndicator = document.getElementById('id-status-indicator');

    // Reports refs
    const reportTitle = document.getElementById('report-title');
    const reportType  = document.getElementById('report-type');
    const reportDesc  = document.getElementById('report-desc');
    const btnCreateReport = document.getElementById('btn-create-report');
    const btnListReports  = document.getElementById('btn-list-reports');
    const reportsListEl   = document.getElementById('reports-list');

    // Warrants refs
    const warrantSubject = document.getElementById('warrant-subject');
    const warrantNetId   = document.getElementById('warrant-netid');
    const warrantCharges = document.getElementById('warrant-charges');
    const btnCreateWarrant = document.getElementById('btn-create-warrant');
    const btnListWarrants  = document.getElementById('btn-list-warrants');
    const warrantsListEl   = document.getElementById('warrants-list');

    // Dispatch refs
    const dispatchCaller   = document.getElementById('dispatch-caller');
    const dispatchLocation = document.getElementById('dispatch-location');
    const dispatchMessage  = document.getElementById('dispatch-message');
    const btnCreateDispatch = document.getElementById('btn-create-dispatch');
    const btnListDispatch   = document.getElementById('btn-list-dispatch');
    const dispatchListEl    = document.getElementById('dispatch-list');

    // Tabs (nav is vertical now, but still uses same selector)
    document.querySelectorAll('nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
        btn.classList.add('active');
        const panel = document.getElementById('panel-' + btn.dataset.tab);
        if (panel) panel.style.display = 'flex';

        // auto-call list when jumping to a section
        const which = btn.dataset.tab;
        if (which === 'reports') sendUI('listReports', {});
        if (which === 'warrants') sendUI('listWarrants', {});
        if (which === 'dispatch') sendUI('listDispatch', {});
      });
    });

    // Close handlers
    if (btnClose) btnClose.onclick = () => sendUI('escape', {});
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') sendUI('escape', {});
      // quick keyboard jump keys (F1-F5) to mimic MDT
      if (e.key === 'F1') document.querySelector('nav button[data-tab="plate"]').click();
      if (e.key === 'F2') document.querySelector('nav button[data-tab="id"]').click();
      if (e.key === 'F3') document.querySelector('nav button[data-tab="reports"]').click();
      if (e.key === 'F4') document.querySelector('nav button[data-tab="warrants"]').click();
      if (e.key === 'F5') document.querySelector('nav button[data-tab="dispatch"]').click();
    });

    // Plate lookup
    if (btnPlate) btnPlate.onclick = () => {
      const plate = (plateInput.value || '').trim();
      if (plate) {
        sendUI('lookupPlate', { plate });
        // also request MDT saved records linked to this plate
        sendUI('listRecords', { target_type: 'plate', target_value: plate });
      }
    };

    // ID lookup (NetID or "First Last")
    if (btnId) btnId.onclick = () => {
      const v = (idInput.value || '').trim();
      if (!v) {
        sendUI('lookupID', {});
        return;
      }
      if (v.indexOf(' ') !== -1) {
        sendUI('lookupID', { name: v });
        // request MDT records saved by name, but also look up 'plate' and 'netid' for tolerance
        sendUI('listRecords', { target_type: 'name', target_value: v });
        sendUI('listRecords', { target_type: 'plate', target_value: v });
        sendUI('listRecords', { target_type: 'netid', target_value: v });
      } else {
        sendUI('lookupID', { netId: v });
        sendUI('listRecords', { target_type: 'netid', target_value: v });
        sendUI('listRecords', { target_type: 'name', target_value: v });
      }
    };

    // History selects handlers
    if (plateHistorySel) plateHistorySel.onchange = () => {
      const v = plateHistorySel.value;
      if (v) {
        plateInput.value = v;
        sendUI('lookupPlate', { plate: v });
        sendUI('listRecords', { target_type: 'plate', target_value: v });
      }
    };

    if (idHistorySel) idHistorySel.onchange = () => {
      const v = idHistorySel.value;
      if (!v) return;
      idInput.value = v;
      if (v.indexOf(' ') !== -1) {
        sendUI('lookupID', { name: v });
        sendUI('listRecords', { target_type: 'name', target_value: v });
      } else {
        sendUI('lookupID', { netId: v });
        sendUI('listRecords', { target_type: 'netid', target_value: v });
      }
    };

    // Reports actions
    if (btnCreateReport) btnCreateReport.onclick = () => {
      const title = (reportTitle.value || '').trim();
      const type  = (reportType.value || 'General').trim();
      const desc  = (reportDesc.value || '').trim();
      if (!title || !desc) return alert('Title and description required');
      sendUI('createReport', { title, description: desc, type });
      // clear
      reportTitle.value = '';
      reportDesc.value = '';
      // refresh list
      setTimeout(() => sendUI('listReports', {}), 250);
    }
    if (btnListReports) btnListReports.onclick = () => sendUI('listReports', {});

    // Warrants actions
    if (btnCreateWarrant) btnCreateWarrant.onclick = () => {
      const name = (warrantSubject.value || '').trim();
      const nid  = (warrantNetId.value || '').trim();
      const ch   = (warrantCharges.value || '').trim();
      if (!name || !ch) return alert('Subject and charges required');
      sendUI('createWarrant', { subject_name: name, subject_netId: nid, charges: ch });
      warrantSubject.value = ''; warrantNetId.value = ''; warrantCharges.value = '';
      setTimeout(() => sendUI('listWarrants', {}), 250);
    }
    if (btnListWarrants) btnListWarrants.onclick = () => sendUI('listWarrants', {});

    // Dispatch actions
    if (btnCreateDispatch) btnCreateDispatch.onclick = () => {
      const caller = (dispatchCaller.value || '').trim();
      const loc = (dispatchLocation.value || '').trim();
      const msg = (dispatchMessage.value || '').trim();
      if (!caller || !loc || !msg) return alert('Fill caller, location and message');
      sendUI('createDispatch', { caller_name: caller, location: loc, message: msg });
      dispatchCaller.value = ''; dispatchLocation.value = ''; dispatchMessage.value = '';
      // server will broadcast; still refresh list shortly
      setTimeout(() => sendUI('listDispatch', {}), 300);
    }
    if (btnListDispatch) btnListDispatch.onclick = () => sendUI('listDispatch', {});

    // Helpers
    function clearChildren(el) {
      while (el && el.firstChild) el.removeChild(el.firstChild);
    }

    function createHeaderGrid(pairsHtml) {
      const grid = document.createElement('div');
      grid.className = 'record-grid header';
      grid.innerHTML = pairsHtml.join('');
      return grid;
    }

    // render helpers for reports/warrants/dispatch
    function renderReports(records) {
      clearChildren(reportsListEl);
      if (!records || records.length === 0) {
        const nr = document.createElement('div'); nr.className='no-results'; nr.textContent='No reports.'; reportsListEl.appendChild(nr); return;
      }
      records.forEach(r => {
        const rec = document.createElement('div'); rec.className='record';
        // Added REPORTER field (shows creator_identifier and optional creator_discord)
        const reporterLabelHtml = `<div class="record-label">REPORTER</div>`;
        const discordPart = r.creator_discord ? ` <span style="font-weight:400;color:var(--muted);font-size:12px">(${escapeHtml(r.creator_discord)})</span>` : '';
        const reporterValueHtml = `<div class="record-value">${escapeHtml(r.creator_identifier || '')}${discordPart}</div>`;

        rec.innerHTML = `
          <div class="record-field">
            <div class="record-label">DATE/TIME</div>
            <div class="record-value">${escapeHtml(r.timestamp || '')}</div>
          </div>

          <div class="record-field" style="display:flex;flex-direction:column;align-items:flex-end">
            <div style="display:flex;gap:8px;align-items:center">
              <div class="record-label">TITLE</div>
              <div class="record-value">${escapeHtml(r.title || r.rtype || '')}</div>
            </div>
            <div style="margin-top:6px">
              <button class="tiny-btn" data-action="delete-report" data-id="${escapeHtml(r.id || '')}">Delete</button>
            </div>
          </div>

          <div style="grid-column:1 / -1;padding-top:8px;font-size:13px;color:var(--muted)">${escapeHtml(r.description || '')}</div>

          <div style="grid-column:1 / -1;margin-top:8px;display:flex;justify-content:flex-start;gap:12px;align-items:center">
            <div style="display:flex;flex-direction:column">
              ${reporterLabelHtml}
              ${reporterValueHtml}
            </div>
          </div>
        `;
        reportsListEl.appendChild(rec);
      });
    }

    function renderWarrants(records) {
      clearChildren(warrantsListEl);
      if (!records || records.length === 0) {
        const nr = document.createElement('div'); nr.className='no-results'; nr.textContent='No warrants.'; warrantsListEl.appendChild(nr); return;
      }
      records.forEach(r => {
        const rec = document.createElement('div'); rec.className='record';
        rec.innerHTML = `
          <div class="record-field">
            <div class="record-label">DATE/TIME</div>
            <div class="record-value">${escapeHtml(r.timestamp || '')}</div>
          </div>
          <div class="record-field">
            <div class="record-label">SUBJECT</div>
            <div class="record-value">${escapeHtml(r.subject_name || '')} ${r.subject_netId ? '('+escapeHtml(r.subject_netId)+')':''}</div>
          </div>
          <div style="grid-column:1 / -1;padding-top:8px;font-size:13px;color:var(--muted)">${escapeHtml(r.charges || '')}</div>
          <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;margin-top:6px">
            <button class="tiny-btn" data-action="remove-warrant" data-id="${escapeHtml(r.id || '')}">${r.active == 1 || r.active === '1' ? 'Revoke' : 'Reactivate'}</button>
          </div>
        `;
        warrantsListEl.appendChild(rec);
      });
    }

    function renderDispatch(records) {
      clearChildren(dispatchListEl);
      if (!records || records.length === 0) {
        const nr = document.createElement('div'); nr.className='no-results'; nr.textContent='No active calls.'; dispatchListEl.appendChild(nr); return;
      }
      records.forEach(r => {
        const rec = document.createElement('div'); rec.className='record';
        const status = escapeHtml(r.status || '');
        rec.innerHTML = `
          <div class="record-field">
            <div class="record-label">DATE/TIME</div>
            <div class="record-value">${escapeHtml(r.timestamp || '')}</div>
          </div>
          <div class="record-field">
            <div class="record-label">CALLER / LOC</div>
            <div class="record-value">${escapeHtml(r.caller_name || '')} — ${escapeHtml(r.location || '')}</div>
          </div>
          <div style="grid-column:1 / -1;padding-top:8px;font-size:13px;color:var(--muted)">${escapeHtml(r.message || '')}</div>
          <div style="grid-column:1 / -1;display:flex;justify-content:space-between;align-items:center;margin-top:6px">
            <div class="small">Status: <strong>${status}</strong></div>
            <div>
              <button class="tiny-btn" data-action="ack-dispatch" data-id="${escapeHtml(r.id || '')}">Acknowledge</button>
            </div>
          </div>
        `;
        dispatchListEl.appendChild(rec);
      });
    }

    // MDT records render helpers (added to show mdt_id_records results) with collapsible details
    function renderMDTRecordsForPlate(records) {
      if (!plateStatus) return;
      // remove previous MDT records container if present
      const existing = plateStatus.querySelector('.mdt-records-container');
      if (existing) existing.remove();

      const container = document.createElement('div');
      container.className = 'mdt-records-container';
      container.style.marginTop = '12px';
      container.innerHTML = `<div class="results-title small">MDT - Saved Records</div>`;
      if (!records || records.length === 0) {
        const nr = document.createElement('div'); nr.className='no-results'; nr.textContent='No MDT records for this plate.'; container.appendChild(nr);
      } else {
        records.forEach(r => {
          const rec = document.createElement('div'); rec.className = 'record';
          // summary area (clickable)
          const title = r.title || r.rtype || '(no title)';
          const ts = r.timestamp || '';
          const creator = r.creator_identifier || r.creator_discord || '';
          const tv = r.target_value || '';
          rec.innerHTML = `
            <div class="record-summary" data-record-id="${escapeHtml(r.id || '')}">
              <div class="record-left">
                <div style="display:flex;flex-direction:column">
                  <div class="record-label">TYPE</div>
                  <div class="record-value">${escapeHtml(title)}</div>
                </div>
                <div style="display:flex;flex-direction:column">
                  <div class="record-label">DATE</div>
                  <div class="tiny-meta">${escapeHtml(ts)}</div>
                </div>
                <div style="display:flex;flex-direction:column">
                  <div class="record-label">TARGET</div>
                  <div class="tiny-meta">${escapeHtml(r.target_type || '')}: ${escapeHtml(tv)}</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div class="tiny-meta" style="margin-right:8px">Saved by: ${escapeHtml(creator)}</div>
                <div class="toggle-icon" data-action="toggle-record" data-id="${escapeHtml(r.id || '')}" title="Expand/Collapse">▸</div>
              </div>
            </div>
            <div class="record-details" data-record-id="${escapeHtml(r.id || '')}">
              <div style="padding-bottom:6px"><strong>Description</strong></div>
              <div style="white-space:pre-wrap;">${escapeHtml(r.description || '')}</div>
              <div style="height:8px"></div>
              <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
                <div><span class="record-label">Creator</span><div class="tiny-meta">${escapeHtml(r.creator_identifier || r.creator_discord || '')}</div></div>
                <div><span class="record-label">Record ID</span><div class="tiny-meta">${escapeHtml(r.id || '')}</div></div>
              </div>
            </div>
          `;
          container.appendChild(rec);
        });
      }
      plateStatus.appendChild(container);
    }

    function renderMDTRecordsForID(records) {
      if (!idResults) return;
      // remove previous MDT records container if present
      const existing = idResults.querySelector('.mdt-records-container');
      if (existing) existing.remove();

      const container = document.createElement('div');
      container.className = 'mdt-records-container';
      container.style.marginTop = '12px';
      container.innerHTML = `<div class="results-title small">MDT - Saved Records</div>`;
      if (!records || records.length === 0) {
        const nr = document.createElement('div'); nr.className='no-results'; nr.textContent='No MDT records for this subject.'; container.appendChild(nr);
      } else {
        records.forEach(r => {
          const rec = document.createElement('div'); rec.className = 'record';
          const title = r.title || r.rtype || '(no title)';
          const ts = r.timestamp || '';
          const creator = r.creator_identifier || r.creator_discord || '';
          const tv = r.target_value || '';
          rec.innerHTML = `
            <div class="record-summary" data-record-id="${escapeHtml(r.id || '')}">
              <div class="record-left">
                <div style="display:flex;flex-direction:column">
                  <div class="record-label">TYPE</div>
                  <div class="record-value">${escapeHtml(title)}</div>
                </div>
                <div style="display:flex;flex-direction:column">
                  <div class="record-label">DATE</div>
                  <div class="tiny-meta">${escapeHtml(ts)}</div>
                </div>
                <div style="display:flex;flex-direction:column">
                  <div class="record-label">TARGET</div>
                  <div class="tiny-meta">${escapeHtml(r.target_type || '')}: ${escapeHtml(tv)}</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div class="tiny-meta" style="margin-right:8px">Saved by: ${escapeHtml(creator)}</div>
                <div class="toggle-icon" data-action="toggle-record" data-id="${escapeHtml(r.id || '')}" title="Expand/Collapse">▸</div>
              </div>
            </div>
            <div class="record-details" data-record-id="${escapeHtml(r.id || '')}">
              <div style="padding-bottom:6px"><strong>Description</strong></div>
              <div style="white-space:pre-wrap;">${escapeHtml(r.description || '')}</div>
              <div style="height:8px"></div>
              <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
                <div><span class="record-label">Creator</span><div class="tiny-meta">${escapeHtml(r.creator_identifier || r.creator_discord || '')}</div></div>
                <div><span class="record-label">Record ID</span><div class="tiny-meta">${escapeHtml(r.id || '')}</div></div>
                <div><span class="record-label">Raw Target</span><div class="tiny-meta">${escapeHtml(r.target_value || '')}</div></div>
              </div>
            </div>
          `;
          container.appendChild(rec);
        });
      }
      idResults.appendChild(container);
    }

    // delegated click handlers (delete/ack/toggle)
    document.body.addEventListener('click', function (ev) {
      const t = ev.target;
      if (!t || !t.dataset) return;
      if (t.dataset.action === 'delete-report') {
        const id = t.dataset.id; if (!id) return;
        if (!confirm('Delete report #' + id + '?')) return;
        sendUI('deleteReport', { id });
        setTimeout(() => sendUI('listReports', {}), 200);
      }
      if (t.dataset.action === 'remove-warrant') {
        const id = t.dataset.id; if (!id) return;
        sendUI('removeWarrant', { id });
        setTimeout(() => sendUI('listWarrants', {}), 200);
      }
      if (t.dataset.action === 'ack-dispatch') {
        const id = t.dataset.id; if (!id) return;
        sendUI('ackDispatch', { id });
        setTimeout(() => sendUI('listDispatch', {}), 200);
      }
      if (t.dataset.action === 'toggle-record' || t.classList.contains('record-summary')) {
        // find surrounding record element
        let rec = t;
        // if clicked the summary inner element, walk up to the .record
        while (rec && !rec.classList.contains('record')) rec = rec.parentNode;
        if (!rec) return;
        // toggle open class
        if (rec.classList.contains('open')) {
          rec.classList.remove('open');
          // update toggle icon(s)
          const icons = rec.querySelectorAll('.toggle-icon');
          icons.forEach(ic => ic.textContent = '▸');
        } else {
          rec.classList.add('open');
          const icons = rec.querySelectorAll('.toggle-icon');
          icons.forEach(ic => ic.textContent = '▾');
        }
      }
    }, true);

    // NUI messages
    window.addEventListener('message', evt => {
      const d = evt.data;
      if (!d) return;

      // open/close
      if (d.action === 'open' && app) {
        app.classList.add('open');
        tryApplySavedLayout();
      }
      if (d.action === 'close' && app) app.classList.remove('open');

      // allow client to request opening a specific tab
      if (d.action === 'openSection') {
        const section = d.section || 'plate';
        const btn = document.querySelector(`nav button[data-tab="${section}"]`);
        if (btn) btn.click();
      }

      // populate initial fields and history list data
      if (d.action === 'populate') {
        if (d.plate != null) plateInput.value = d.plate;

        if (d.lastPedName && d.lastPedName !== '') idInput.value = d.lastPedName;
        else if (d.netId != null && d.netId !== '') idInput.value = d.netId;
        else idInput.value = '';

        if (Array.isArray(d.plateHistory) && plateHistorySel) {
          plateHistorySel.innerHTML = '<option value="">-- Select previous search --</option>';
          d.plateHistory.forEach(p => {
            const o = document.createElement('option');
            o.value = p;
            o.textContent = p;
            plateHistorySel.appendChild(o);
          });
        }

        if (Array.isArray(d.idHistory) && idHistorySel) {
          idHistorySel.innerHTML = '<option value="">-- Select previous search --</option>';
          d.idHistory.forEach(i => {
            const o = document.createElement('option');
            o.value = i;
            o.textContent = i;
            idHistorySel.appendChild(o);
          });
        }
      }

      // plateResult rendering
      if (d.action === 'plateResult' && plateStatus && plateIndicator) {
        clearChildren(plateStatus);
        const st = (d.status || '').toLowerCase();
        plateIndicator.textContent = d.status || '';
        plateIndicator.className = 'status small ' + st;

        const grid = createHeaderGrid([
          `<div>PLATE</div><div>${escapeHtml(d.plate || '')}</div>`,
          `<div>MAKE/MODEL</div><div>${escapeHtml(d.make || '')}</div>`,
          `<div>COLOR</div><div>${escapeHtml(d.color || '')}</div>`,
          `<div>OWNER</div><div>${escapeHtml(d.owner || '')}</div>`,
          `<div>INSURANCE</div><div>${escapeHtml(d.insurance || '')}</div>`
        ]);
        plateStatus.appendChild(grid);

        const records = Array.isArray(d.records) ? d.records : [];
        if (records.length === 0) {
          const nr = document.createElement('div');
          nr.className = 'no-results';
          nr.textContent = 'No history records for this plate.';
          plateStatus.appendChild(nr);
        } else {
          records.forEach(r => {
            const whoName = ((r.first_name || '') + (r.last_name ? ' ' + r.last_name : '')).trim() ||
              r.identifier || '';
            const rec = document.createElement('div');
            rec.className = 'record';
            rec.innerHTML = `
              <div class="record-field">
                <div class="record-label">DATE/TIME</div>
                <div class="record-value">${escapeHtml(r.timestamp || '')}</div>
              </div>
              <div class="record-field">
                <div class="record-label">INCIDENT</div>
                <div class="record-value">${escapeHtml(whoName || r.identifier || '')}</div>
              </div>
            `;
            plateStatus.appendChild(rec);
          });
        }
      }

      // idResult rendering
      if (d.action === 'idResult' && idResults && idIndicator) {
        clearChildren(idResults);
        const ls = (d.licenseStatus || '').toLowerCase();
        idIndicator.textContent = d.licenseStatus || '';
        idIndicator.className = 'status small ' + ls;

        const headerPairs = [
          `<div>NET ID</div><div>${escapeHtml(d.netId || '')}</div>`,
          `<div>NAME</div><div>${escapeHtml(d.name || '')}</div>`,
          `<div>DOB</div><div>${escapeHtml(d.dob || '')}</div>`,
          `<div>LICENSE</div><div>${escapeHtml(d.licenseStatus || '')}</div>`
        ];
        const info = createHeaderGrid(headerPairs);
        idResults.appendChild(info);

        const records = Array.isArray(d.records) ? d.records : [];
        if (records.length === 0) {
          const nr = document.createElement('div');
          nr.className = 'no-results';
          nr.textContent = 'No ID history found.';
          idResults.appendChild(nr);
        } else {
          records.forEach(r => {
            const whoName = ((r.first_name || '') + (r.last_name ? ' ' + r.last_name : '')).trim() ||
              r.identifier || r.netId || '';
            const rec = document.createElement('div');
            rec.className = 'record';
            rec.innerHTML = `
              <div class="record-field">
                <div class="record-label">DATE/TIME</div>
                <div class="record-value">${escapeHtml(r.timestamp || '')}</div>
              </div>
              <div class="record-field">
                <div class="record-label">TYPE</div>
                <div class="record-value">${escapeHtml(r.type || whoName || '')}</div>
              </div>
            `;
            idResults.appendChild(rec);
          });
        }

        if (Array.isArray(d.records) && idHistorySel) {
          idHistorySel.innerHTML = '<option value="">-- Select previous search --</option>';
          const seen = new Set();
          d.records.forEach(r => {
            const display = ((r.first_name || '') + (r.last_name ? ' ' + r.last_name : '')).trim() ||
              r.netId || r.identifier || '';
            if (display && !seen.has(display)) {
              seen.add(display);
              const o = document.createElement('option');
              o.value = display;
              o.textContent = display;
              idHistorySel.appendChild(o);
            }
          });
        }
      }

      // mdt created records result
      if (d.action === 'recordsResult') {
        const recs = d.records || d.result || [];
        const ttype = d.target_type || d.targetType || '';
        if (ttype === 'plate') {
          renderMDTRecordsForPlate(recs);
        } else {
          renderMDTRecordsForID(recs);
        }

        // populate history dropdown for idHistory if possible
        if (Array.isArray(recs) && recs.length > 0 && idHistorySel) {
          const seen = new Set(Array.from(idHistorySel.options).map(o => o.value));
          recs.forEach(r => {
            const display = (r.target_value || (r.first_name ? (r.first_name + (r.last_name ? ' ' + r.last_name : '')) : r.netId || r.identifier || ''));
            if (display && !seen.has(display)) {
              seen.add(display);
              const o = document.createElement('option');
              o.value = display;
              o.textContent = display;
              idHistorySel.appendChild(o);
            }
          });
        }
      }

      // reportsResult
      if (d.action === 'reportsResult') {
        renderReports(d.records || []);
      }

      // warrantsResult
      if (d.action === 'warrantsResult') {
        renderWarrants(d.records || []);
      }

      // dispatchResult
      if (d.action === 'dispatchResult') {
        renderDispatch(d.records || []);
      }

      // dispatchNotify (push)
      if (d.action === 'dispatchNotify' && d.call) {
        // make a little visual ping in dispatch tab
        const prev = document.querySelector('nav button[data-tab="dispatch"]');
        if (prev) {
          prev.classList.add('active');
          // show brief highlight
          prev.style.boxShadow = 'inset 0 0 18px rgba(0,255,140,0.1)';
          setTimeout(()=>prev.style.boxShadow='',800);
        }
        // show the call in the dispatch panel (prepend)
        // fetch fresh list too
        setTimeout(()=> sendUI('listDispatch', {}), 200);
        // also show modal-like notification in results area
        const c = d.call;
        // small DOM toast in dispatch-list
        const toast = document.createElement('div');
        toast.className = 'record';
        toast.innerHTML = `
          <div class="record-field">
            <div class="record-label">NEW CALL</div>
            <div class="record-value">${escapeHtml(c.caller_name || '')} — ${escapeHtml(c.location || '')}</div>
          </div>
          <div class="record-field">
            <div class="record-label">TIME</div>
            <div class="record-value">${escapeHtml(c.timestamp || '')}</div>
          </div>
          <div style="grid-column:1 / -1;padding-top:8px;font-size:13px;color:var(--muted)">${escapeHtml(c.message || '')}</div>
          <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;margin-top:6px">
            <button class="tiny-btn" data-action="ack-dispatch" data-id="${escapeHtml(c.id || '')}">Acknowledge</button>
          </div>
        `;
        // prepend to dispatch list area
        if (dispatchListEl) {
          dispatchListEl.insertBefore(toast, dispatchListEl.firstChild);
        }
      }
    });

    // escape helper
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // -----------------------
    // Drag & Resize logic
    // -----------------------
    function px(v){ return parseFloat(String(v||'').replace('px',''))||0; }

    // apply saved layout when opened
    let appliedSaved = false;
    function tryApplySavedLayout(){
      if (appliedSaved) return;
      appliedSaved = true;
      const s = loadLayoutState();
      if (s && app) {
        if (s.left !== undefined && s.top !== undefined) {
          app.style.left = s.left + 'px';
          app.style.top = s.top + 'px';
          app.style.transform = 'none';
        }
        if (s.width) app.style.width = s.width + 'px';
        if (s.height) app.style.height = s.height + 'px';
      }
    }

    // initial apply if app already open
    (function initSavedPosition(){
      const s = loadLayoutState();
      if (s && app) {
        if (s.left !== undefined && s.top !== undefined) { app.style.left = s.left + 'px'; app.style.top = s.top + 'px'; app.style.transform = 'none'; }
        if (s.width) app.style.width = s.width + 'px';
        if (s.height) app.style.height = s.height + 'px';
      }
    })();

    // Drag (header)
    (function enableDrag(){
      if (!header || !app) return;
      let dragging=false, sx=0, sy=0, startLeft=0, startTop=0;
      function onDown(e){
        if (e.button !== undefined && e.button !== 0) return;
        dragging=true;
        sx = e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX);
        sy = e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY);
        startLeft = px(window.getComputedStyle(app).left || app.style.left) || (window.innerWidth/2 - app.offsetWidth/2);
        startTop = px(window.getComputedStyle(app).top || app.style.top) || (window.innerHeight*0.05);
        if (app.style.transform && app.style.transform.indexOf('translateX') !== -1) app.style.transform = 'none';
        document.addEventListener('pointermove', onMove);
        document.addEventListener('pointerup', onUp);
        e.preventDefault();
      }
      function onMove(e){
        if (!dragging) return;
        const cx = e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX);
        const cy = e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY);
        const dx = cx - sx, dy = cy - sy;
        let nl = startLeft + dx, nt = startTop + dy;
        const maxLeft = window.innerWidth - app.offsetWidth - 8;
        const maxTop = window.innerHeight - app.offsetHeight - 8;
        nl = Math.max(8, Math.min(maxLeft, nl));
        nt = Math.max(8, Math.min(maxTop, nt));
        app.style.left = Math.round(nl) + 'px';
        app.style.top  = Math.round(nt) + 'px';
      }
      function onUp(){
        if (!dragging) return;
        dragging=false;
        document.removeEventListener('pointermove', onMove);
        document.removeEventListener('pointerup', onUp);
        saveLayoutState({
          left: Math.round(px(app.style.left || window.getComputedStyle(app).left)),
          top:  Math.round(px(app.style.top  || window.getComputedStyle(app).top)),
          width: Math.round(px(app.style.width || window.getComputedStyle(app).width)),
          height: Math.round(px(app.style.height || window.getComputedStyle(app).height))
        });
      }
      header.addEventListener('pointerdown', onDown);
      header.addEventListener('dblclick', function(){
        app.style.left = '50%';
        app.style.top = '5%';
        app.style.transform = 'translateX(-50%)';
        saveLayoutState({ left: undefined, top: undefined, width: Math.round(px(app.style.width || window.getComputedStyle(app).width)), height: Math.round(px(app.style.height || window.getComputedStyle(app).height)) });
      });
    })();

    // Resize (grip)
    (function enableResize(){
      if (!grip || !app) return;
      // defensive: ensure grip remains a child of app so positioning is relative to app
      if (grip.parentNode !== app) app.appendChild(grip);

      let resizing=false, sx=0, sy=0, startW=0, startH=0;
      const MIN_W = 480, MIN_H = 340;
      function onDown(e){
        if (e.button !== undefined && e.button !== 0) return;
        resizing=true;
        sx = e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX);
        sy = e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY);
        startW = app.offsetWidth;
        startH = app.offsetHeight;
        document.addEventListener('pointermove', onMove);
        document.addEventListener('pointerup', onUp);
        e.preventDefault();
      }
      function onMove(e){
        if (!resizing) return;
        const cx = e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX);
        const cy = e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY);
        const dx = cx - sx, dy = cy - sy;
        let nw = Math.max(MIN_W, startW + dx);
        let nh = Math.max(MIN_H, startH + dy);
        // clamp to viewport
        const currentLeft = px(app.style.left || window.getComputedStyle(app).left) || 8;
        nw = Math.min(window.innerWidth - currentLeft - 8, nw);
        const currentTop = px(app.style.top || window.getComputedStyle(app).top) || 8;
        nh = Math.min(window.innerHeight - currentTop - 8, nh);
        app.style.width = Math.round(nw) + 'px';
        app.style.height = Math.round(nh) + 'px';
      }
      function onUp(){
        if (!resizing) return;
        resizing=false;
        document.removeEventListener('pointermove', onMove);
        document.removeEventListener('pointerup', onUp);
        saveLayoutState({
          left: px(app.style.left || window.getComputedStyle(app).left) || undefined,
          top: px(app.style.top || window.getComputedStyle(app).top) || undefined,
          width: Math.round(px(app.style.width || window.getComputedStyle(app).width)),
          height: Math.round(px(app.style.height || window.getComputedStyle(app).height))
        });
      }
      grip.addEventListener('pointerdown', onDown);

      // keyboard accessibility for grip (arrows change size)
      grip.addEventListener('keydown', (e) => {
        const step = e.shiftKey ? 10 : 30;
        if (!app) return;
        switch(e.key){
          case 'ArrowRight': app.style.width = (app.offsetWidth + step) + 'px'; break;
          case 'ArrowLeft': app.style.width = Math.max(MIN_W, app.offsetWidth - step) + 'px'; break;
          case 'ArrowDown': app.style.height = (app.offsetHeight + step) + 'px'; break;
          case 'ArrowUp': app.style.height = Math.max(MIN_H, app.offsetHeight - step) + 'px'; break;
          case 'Enter':
            saveLayoutState({ left: px(app.style.left || window.getComputedStyle(app).left) || undefined, top: px(app.style.top || window.getComputedStyle(app).top) || undefined, width: Math.round(px(app.style.width || window.getComputedStyle(app).width)), height: Math.round(px(app.style.height || window.getComputedStyle(app).height)) });
            break;
        }
      });
    })();

    // keep MDT on-screen after viewport resize
    window.addEventListener('resize', () => {
      if (!app) return;
      const left = px(app.style.left || window.getComputedStyle(app).left);
      const top  = px(app.style.top  || window.getComputedStyle(app).top);
      const w    = app.offsetWidth;
      const h    = app.offsetHeight;
      let changed=false;
      let newLeft = left, newTop = top;
      if (left + w > window.innerWidth - 8) { newLeft = Math.max(8, window.innerWidth - w - 8); changed=true; }
      if (top + h > window.innerHeight - 8) { newTop = Math.max(8, window.innerHeight - h - 8); changed=true; }
      if (changed) { app.style.left = newLeft + 'px'; app.style.top = newTop + 'px'; saveLayoutState({ left: Math.round(newLeft), top: Math.round(newTop), width: Math.round(w), height: Math.round(h) }); }
    });

    // Try to apply saved layout immediately on open if message triggers open
    let applied = false;
    function tryApplySavedLayout(){
      if (applied) return;
      applied = true;
      const s = loadLayoutState();
      if (s && app) {
        if (s.left !== undefined && s.top !== undefined) { app.style.left = s.left + 'px'; app.style.top = s.top + 'px'; app.style.transform = 'none'; }
        if (s.width) app.style.width = s.width + 'px';
        if (s.height) app.style.height = s.height + 'px';
      }
    }

    // expose for debugging
    window._ncic_sendUI = sendUI;

    // defensive: ensure grip is last child so it sits visually above content
    if (grip && app && grip.parentNode !== app) app.appendChild(grip);
    if (grip) grip.style.left = 'auto'; // force left auto so right placement is used
  })();
</script>

<!-- Compose handler script: attaches compose buttons, opens modal, sends createRecord -->
<script>
(function(){
  const modalBackdrop = document.getElementById('compose-modal-backdrop');
  const btns = Array.from(document.querySelectorAll('.btn-compose'));
  const closeBtn = document.getElementById('compose-close');
  const cancelBtn = document.getElementById('compose-cancel');
  const submitBtn = document.getElementById('compose-submit');

  const ctType = document.getElementById('compose-type');
  const ctTargetType = document.getElementById('compose-target-type');
  const ctTargetValue = document.getElementById('compose-target-value');
  const ctTitle = document.getElementById('compose-title');
  const ctDesc = document.getElementById('compose-desc');
  const ctMeta = document.getElementById('compose-meta');

  if (!modalBackdrop) {
    console.warn('[NCIC] compose modal missing: #compose-modal-backdrop');
    return;
  }

  function openCompose(prefillTargetType, prefillTargetValue) {
    if (prefillTargetType && ctTargetType) ctTargetType.value = prefillTargetType;
    if (prefillTargetValue && ctTargetValue) ctTargetValue.value = prefillTargetValue;
    if (window._ncic_creator_identifier) {
      ctMeta.textContent = 'Creator: ' + window._ncic_creator_identifier + (window._ncic_creator_discord ? (' ('+window._ncic_creator_discord+')') : '');
    } else {
      ctMeta.textContent = '';
    }
    modalBackdrop.style.display = 'flex';
    setTimeout(()=>{ if(ctTitle) ctTitle.focus(); }, 50);
  }
  function closeCompose() {
    modalBackdrop.style.display = 'none';
  }

  if (btns && btns.length) {
    btns.forEach(b => b.addEventListener('click', ()=> {
      const plateVisible = (document.getElementById('panel-plate') || {}).style.display !== 'none';
      const idVisible = (document.getElementById('panel-id') || {}).style.display !== 'none';
      const plateVal = (document.getElementById('plate-input') || {}).value || '';
      const idVal = (document.getElementById('id-input') || {}).value || '';
      if (plateVisible && plateVal.trim()) openCompose('plate', plateVal.trim());
      else if (idVisible && idVal.trim()) openCompose('name', idVal.trim());
      else openCompose('plate', plateVal.trim() || idVal.trim() || '');
    }));
  } else {
    console.warn('[NCIC] no .btn-compose found');
  }

  if (closeBtn) closeBtn.addEventListener('click', closeCompose);
  if (cancelBtn) cancelBtn.addEventListener('click', closeCompose);

  modalBackdrop.addEventListener('click', (ev) => {
    if (ev.target === modalBackdrop) closeCompose();
  });

  if (submitBtn) submitBtn.addEventListener('click', ()=>{
    const target_type = (ctTargetType && ctTargetType.value) || 'plate';
    const target_value = ((ctTargetValue && ctTargetValue.value) || '').trim();
    const rtype = (ctType && ctType.value) || 'note';
    const title = ((ctTitle && ctTitle.value) || '').trim();
    const description = ((ctDesc && ctDesc.value) || '').trim();

    if (!target_value || !title || !description) {
      return alert('Target, title and description are required.');
    }

    const payload = {
      target_type,
      target_value,
      rtype,
      title,
      description,
      creator_identifier: window._ncic_creator_identifier || '',
      creator_discord: window._ncic_creator_discord || ''
    };

    try {
      if (typeof window._ncic_sendUI === 'function') {
        window._ncic_sendUI('createRecord', payload);
      } else {
        try { fetch(`https://${GetParentResourceName()}/createRecord`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } catch(e){}
      }
    } catch (e) {
      console.error('[NCIC] createRecord send error', e);
    }

    closeCompose();

    setTimeout(() => {
      if (typeof window._ncic_sendUI === 'function') window._ncic_sendUI('listRecords', { target_type, target_value });
    }, 250);
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modalBackdrop.style.display === 'flex') closeCompose();
  });
})();
</script>


<!-- MDT recordsResult & id/plate result renderer - inserted by ChatGPT -->
<script>
(function(){
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

  function renderRecordsToContainer(records, container, headerHtml){
    if (!container) return;
    container.innerHTML = '';
    if (headerHtml) {
      const h = document.createElement('div');
      h.className = 'results-subheader';
      h.innerHTML = headerHtml;
      container.appendChild(h);
    }
    if (!records || records.length === 0) {
      const no = document.createElement('div');
      no.className = 'no-results';
      no.textContent = 'No MDT records for this subject.';
      container.appendChild(no);
      return;
    }

    records.forEach(r => {
      const rec = r || {};
      const box = document.createElement('div');
      box.className = 'record-item';
      box.style.padding = '8px';
      box.style.margin = '8px 0';
      box.style.borderTop = '1px solid rgba(255,255,255,0.03)';
      box.style.background = 'transparent';

      const dt = rec.timestamp || rec.time || rec.date || '';
      const type = rec.rtype || rec.type || rec.record_type || rec.target_type || '--';
      const title = rec.title || rec.first_name || rec.name || '';
      const desc = rec.description || rec.desc || rec.details || '';
      const creator = rec.creator_identifier || rec.creator || rec.creator_discord || rec.identifier || '';

      let inner = '<div style="display:flex;justify-content:space-between;align-items:flex-start">';
      inner += '<div style="font-size:12px;color:#9adbb6">'+escapeHtml(dt)+'</div>';
      inner += '<div style="font-size:12px;color:#8ef6b1">TYPE<br/><strong>'+escapeHtml(type)+'</strong></div>';
      inner += '<div style="font-size:12px;color:#9adbb6">Creator:<br/>'+escapeHtml(creator)+'</div>';
      inner += '</div>';

      if (title && title !== '') inner += '<div style="font-weight:700;margin-top:6px;color:#9adbb6">'+escapeHtml(title)+'</div>';
      if (desc && desc !== '') inner += '<div style="margin-top:6px;color:#9adbb6">'+escapeHtml(desc)+'</div>';

      // show other keys
      const skip = new Set(['id','target_type','target_value','rtype','type','title','description','desc','creator_identifier','creator','creator_discord','creatorDiscord','timestamp','time','date','first_name','last_name','identifier','netId']);
      const otherKeys = Object.keys(rec).filter(k => !skip.has(k) && rec[k] !== null && rec[k] !== undefined && String(rec[k]).trim() !== '');
      if (otherKeys.length > 0) {
        inner += '<div style="margin-top:8px;font-size:12px;color:#9adbb6">Additional Info:</div><ul style="margin:6px 0 0 16px;color:#9adbb6">';
        otherKeys.forEach(k => {
          inner += '<li><strong>'+escapeHtml(k)+':</strong> '+escapeHtml(String(rec[k]))+'</li>';
        });
        inner += '</ul>';
      }

      box.innerHTML = inner;
      container.appendChild(box);
    });
  }

  window.addEventListener('message', function(event){
    const d = event.data;
    if (!d || !d.action) return;

    // Normalize records from various payloads
    let records = [];
    let target_type = null;
    let headerHtml = '';

    if (d.action === 'recordsResult') {
      records = d.records || d.result || d.data || d || [];
      target_type = d.target_type || d.targetType || null;
    } else if (d.action === 'idResult') {
      // d may contain: { action:'idResult', netId, name, licenseStatus, records: [...] }
      records = d.records || [];
      target_type = 'name';
      headerHtml = '<div class="id-header"><strong>Name:</strong> '+escapeHtml(d.name||'')+' &nbsp; <strong>License:</strong> '+escapeHtml(d.licenseStatus||'')+'</div>';
    } else if (d.action === 'plateResult') {
      // d may contain: { action:'plateResult', plate, status, records: [...] }
      records = d.records || d.records || d.data || [];
      target_type = 'plate';
      headerHtml = '<div class="plate-header"><strong>Plate:</strong> '+escapeHtml(d.plate||'')+' &nbsp; <strong>Status:</strong> '+escapeHtml(d.status||'')+'</div>';
    } else {
      // ignore other actions
      return;
    }

    // If records is an object with nested array, try common keys
    if (!Array.isArray(records) && typeof records === 'object') {
      const tryKeys = ['records','data','rows','result','mdt_id_records','mdt_id_record'];
      for (const k of tryKeys){
        if (Array.isArray(records[k])) { records = records[k]; break; }
      }
    }

    if (!Array.isArray(records) && Array.isArray(d)) records = d;

    // Decide container: plate -> #plate-status, otherwise #id-results
    let container = null;
    if (target_type === 'plate' || (d.action === 'plateResult')) {
      container = document.querySelector('#plate-status') || document.querySelector('#panel-plate .scroll') || document.querySelector('.panel#panel-plate .scroll');
    } else {
      container = document.querySelector('#id-results') || document.querySelector('#panel-id .scroll') || document.querySelector('.panel#panel-id .scroll');
    }

    // As a fallback try generic results container
    if (!container) container = document.querySelector('.results') || document.querySelector('.results .scroll');

    renderRecordsToContainer(records, container, headerHtml);
  });
})();
</script>
<!-- end inserted renderer -->
</body>
</html>
